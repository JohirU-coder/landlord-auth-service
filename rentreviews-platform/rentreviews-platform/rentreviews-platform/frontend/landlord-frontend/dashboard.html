<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RentReviews - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-cyan-50 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-gray-600 font-medium">Loading your dashboard...</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 w-8 h-8 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-sm">‚≠ê</span>
                        </div>
                        <span class="ml-3 text-xl font-bold text-gray-900">RentReviews</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button id="userMenuButton" class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 w-8 h-8 rounded-full flex items-center justify-center">
                                <span id="userInitials" class="text-white font-medium text-sm loading-skeleton w-4 h-4 rounded"></span>
                            </div>
                            <span id="userNameNav" class="ml-3 text-gray-700 font-medium loading-skeleton w-20 h-4 rounded"></span>
                        </button>
                    </div>
                    <button id="logoutBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <!-- Welcome Section -->
            <div class="bg-white overflow-hidden shadow-xl rounded-lg mb-8">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-8 py-12">
                    <div class="flex items-center">
                        <div class="bg-white bg-opacity-20 p-3 rounded-full">
                            <span class="text-white text-2xl">üëã</span>
                        </div>
                        <div class="ml-6">
                            <h1 id="welcomeMessage" class="text-3xl font-bold text-white">
                                <span class="loading-skeleton w-64 h-8 rounded inline-block"></span>
                            </h1>
                            <p class="text-indigo-100 mt-2 text-lg">
                                Here's what's happening with your rental search
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Reviews Written -->
                <div class="bg-white overflow-hidden shadow-lg rounded-lg">
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-indigo-500 p-3 rounded-lg">
                                    <span class="text-white text-xl">‚≠ê</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-3xl font-bold text-gray-900">0</div>
                                <div class="text-sm font-medium text-gray-500">Reviews Written</div>
                                <div class="text-xs text-gray-400 mt-1">Help other renters by sharing your experience</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Properties Saved -->
                <div class="bg-white overflow-hidden shadow-lg rounded-lg">
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-green-500 p-3 rounded-lg">
                                    <span class="text-white text-xl">üè†</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-3xl font-bold text-gray-900">0</div>
                                <div class="text-sm font-medium text-gray-500">Properties Saved</div>
                                <div class="text-xs text-gray-400 mt-1">Keep track of places you're interested in</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Status -->
                <div class="bg-white overflow-hidden shadow-lg rounded-lg">
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-purple-500 p-3 rounded-lg">
                                    <span class="text-white text-xl">üë§</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-bold text-green-600 bg-green-100 px-2 py-1 rounded-full">ACTIVE</div>
                                <div class="text-sm font-medium text-gray-500 mt-1">Account Status</div>
                                <div id="userRole" class="text-xs text-gray-400 mt-1">
                                    <span class="loading-skeleton w-20 h-3 rounded inline-block"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-8">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Quick Actions</h3>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Search Properties -->
                        <button id="searchPropertiesBtn" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4 rounded-lg hover:from-indigo-600 hover:to-purple-700 transition-all transform hover:scale-105">
                            <div class="text-2xl mb-2">üîç</div>
                            <div class="font-medium">Search Properties</div>
                            <div class="text-xs opacity-90 mt-1">Find your next home</div>
                        </button>

                        <!-- Write Review -->
                        <button id="writeReviewBtn" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all transform hover:scale-105">
                            <div class="text-2xl mb-2">‚úèÔ∏è</div>
                            <div class="font-medium">Write Review</div>
                            <div class="text-xs opacity-90 mt-1">Share your experience</div>
                        </button>

                        <!-- Market Insights -->
                        <button id="marketInsightsBtn" class="bg-gradient-to-r from-blue-500 to-cyan-600 text-white p-4 rounded-lg hover:from-blue-600 hover:to-cyan-700 transition-all transform hover:scale-105">
                            <div class="text-2xl mb-2">üìä</div>
                            <div class="font-medium">Market Insights</div>
                            <div class="text-xs opacity-90 mt-1">Rental market trends</div>
                        </button>

                        <!-- Upgrade to Pro -->
                        <button id="upgradeProBtn" class="bg-gradient-to-r from-orange-500 to-red-600 text-white p-4 rounded-lg hover:from-orange-600 hover:to-red-700 transition-all transform hover:scale-105">
                            <div class="text-2xl mb-2">‚ö°</div>
                            <div class="font-medium">Upgrade to Pro</div>
                            <div class="text-xs opacity-90 mt-1">Unlock premium features</div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Activity (Empty State) -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Recent Activity</h3>
                </div>
                <div class="p-12 text-center">
                    <div class="text-gray-400 text-6xl mb-4">üìã</div>
                    <h4 class="text-lg font-medium text-gray-900 mb-2">No activity yet</h4>
                    <p class="text-gray-500 mb-6">Start by searching for properties or writing your first review!</p>
                    <button id="getStartedBtn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                        Get Started
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // üîß FIXED: Dashboard with Profile API Integration
        class Dashboard {
            constructor() {
                this.user = null;
                this.token = null;
                this.API_BASE_URL = 'https://landlord-auth-service-production.up.railway.app';
                this.init();
            }

            async init() {
                console.log('üè† Dashboard initializing...');
                await this.loadUserData();
                this.setupEventListeners();
                this.hideLoadingOverlay();
            }

            async loadUserData() {
                try {
                    // Get token from localStorage
                    this.token = localStorage.getItem('rentreviews_token');
                    
                    if (!this.token) {
                        console.warn('‚ùå No authentication token found');
                        this.redirectToAuth();
                        return;
                    }

                    // Check if token is still valid
                    if (!this.isTokenValid(this.token)) {
                        console.warn('‚ùå Token expired');
                        this.redirectToAuth();
                        return;
                    }

                    console.log('‚úÖ Valid token found, fetching profile...');

                    // Try to get cached user data first
                    const cachedUser = localStorage.getItem('rentreviews_user');
                    if (cachedUser) {
                        this.user = JSON.parse(cachedUser);
                        console.log('üì± Using cached user data:', this.user);
                        this.updateUIImmediately();
                    }

                    // Always fetch fresh profile data from API
                    await this.fetchProfileData();

                } catch (error) {
                    console.error('‚ùå Error loading user data:', error);
                    this.redirectToAuth();
                }
            }

            async fetchProfileData() {
                try {
                    console.log('üîÑ Fetching fresh profile data from API...');
                    
                    const response = await fetch(`${this.API_BASE_URL}/profile`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        },
                        mode: 'cors'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        
                        // üîß FIXED: Handle different response formats
                        let userData = null;
                        if (data.success && data.user) {
                            // Format: { success: true, user: {...} }
                            userData = data.user;
                        } else if (data.user) {
                            // Format: { user: {...} }
                            userData = data.user;
                        } else if (data.id) {
                            // Format: direct user object
                            userData = data;
                        }
                        
                        if (userData) {
                            console.log('‚úÖ Fresh profile data received:', userData);
                            
                            // Update stored user data
                            this.user = userData;
                            localStorage.setItem('rentreviews_user', JSON.stringify(userData));
                            
                            // Update UI with fresh data
                            this.updateUI();
                        } else {
                            console.warn('‚ö†Ô∏è Invalid profile response format:', data);
                        }
                    } else if (response.status === 401 || response.status === 403) {
                        console.warn('‚ùå Authentication failed, token invalid');
                        this.redirectToAuth();
                    } else {
                        console.warn('‚ö†Ô∏è Profile fetch failed:', response.status);
                        // Continue with cached data if available
                        if (this.user) {
                            console.log('üì± Continuing with cached user data');
                            this.updateUI();
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error fetching profile:', error);
                    
                    // Continue with cached data if available
                    if (this.user) {
                        console.log('üì± Using cached data due to fetch error');
                        this.updateUI();
                    } else {
                        this.redirectToAuth();
                    }
                }
            }

            isTokenValid(token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    return payload.exp * 1000 > Date.now();
                } catch {
                    return false;
                }
            }

            updateUIImmediately() {
                // Quick update for cached data to remove skeleton loaders
                if (this.user) {
                    this.updateBasicUI();
                }
            }

            updateBasicUI() {
                if (!this.user) return;

                try {
                    // Update user initials (remove skeleton)
                    const userInitials = document.getElementById('userInitials');
                    if (userInitials && this.user.first_name && this.user.last_name) {
                        userInitials.className = 'text-white font-medium text-sm';
                        userInitials.textContent = `${this.user.first_name.charAt(0)}${this.user.last_name.charAt(0)}`.toUpperCase();
                    }

                    // Update navigation name (remove skeleton)
                    const userNameNav = document.getElementById('userNameNav');
                    if (userNameNav) {
                        userNameNav.className = 'ml-3 text-gray-700 font-medium';
                        const firstName = this.user.first_name || '';
                        const lastName = this.user.last_name || '';
                        userNameNav.textContent = `${firstName} ${lastName}`.trim() || 'User';
                    }
                } catch (error) {
                    console.error('‚ùå Error in updateBasicUI:', error);
                }
            }

            updateUI() {
                if (!this.user) {
                    console.warn('‚ö†Ô∏è No user data available for UI update');
                    return;
                }

                try {
                    // Update welcome message
                    const welcomeMessage = document.getElementById('welcomeMessage');
                    if (welcomeMessage) {
                        welcomeMessage.className = 'text-3xl font-bold text-white fade-in';
                        const firstName = this.user.first_name || 'User';
                        welcomeMessage.textContent = `Welcome back, ${firstName}!`;
                    }

                    // Update navigation elements
                    this.updateBasicUI();

                    // Update user role
                    const userRole = document.getElementById('userRole');
                    if (userRole) {
                        userRole.className = 'text-xs text-gray-400 mt-1';
                        const role = this.user.role || 'user';
                        userRole.textContent = `${role.charAt(0).toUpperCase() + role.slice(1)} Account`;
                    }

                    console.log('‚úÖ UI updated successfully');

                } catch (error) {
                    console.error('‚ùå Error updating UI:', error);
                }
            }

            hideLoadingOverlay() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        overlay.style.display = 'none';
                    }, 300);
                }
            }

            setupEventListeners() {
                // Logout functionality
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => this.logout());
                }

                // Quick Actions buttons
                this.setupQuickActions();

                // Get Started button
                const getStartedBtn = document.getElementById('getStartedBtn');
                if (getStartedBtn) {
                    getStartedBtn.addEventListener('click', () => {
                        window.location.href = './search.html';
                    });
                }
            }

            setupQuickActions() {
                // Search Properties button
                const searchBtn = document.getElementById('searchPropertiesBtn');
                if (searchBtn) {
                    searchBtn.addEventListener('click', () => {
                        console.log('üîç Search Properties clicked!');
                        window.location.href = './search.html';
                    });
                }
                
                // Write Review button  
                const writeReviewBtn = document.getElementById('writeReviewBtn');
                if (writeReviewBtn) {
                    writeReviewBtn.addEventListener('click', () => {
                        console.log('‚úèÔ∏è Write Review clicked!');
                        window.location.href = './write-review.html';
                    });
                }
                
                // Market Insights button
                const marketBtn = document.getElementById('marketInsightsBtn');
                if (marketBtn) {
                    marketBtn.addEventListener('click', () => {
                        console.log('üìä Market Insights clicked!');
                        window.location.href = './market-insights.html';
                    });
                }
                
                // Upgrade to Pro button
                const proBtn = document.getElementById('upgradeProBtn');
                if (proBtn) {
                    proBtn.addEventListener('click', () => {
                        console.log('‚ö° Upgrade to Pro clicked!');
                        alert('Upgrade to Pro feature coming soon!');
                    });
                }
            }

            logout() {
                try {
                    console.log('üëã Logging out...');
                    
                    // Clear all authentication data
                    localStorage.removeItem('rentreviews_token');
                    localStorage.removeItem('rentreviews_user');
                    localStorage.removeItem('token'); // Clear old format too
                    localStorage.removeItem('user'); // Clear old format too
                    
                    console.log('‚úÖ Logout successful');
                    this.redirectToAuth();
                } catch (error) {
                    console.error('‚ùå Logout error:', error);
                    this.redirectToAuth();
                }
            }

            redirectToAuth() {
                window.location.href = './auth.html';
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new Dashboard();
        });

        // Security warning
        console.warn(
            '%cStop!',
            'color: red; font-size: 50px; font-weight: bold;'
        );
        console.warn(
            'This is a browser feature intended for developers. If someone told you to copy-paste something here to enable a feature or "hack" someone\'s account, it is a scam and will give them access to your account.'
        );
    </script>
</body>
</html>